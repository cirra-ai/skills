name: Build & Publish

# On release published:
#   - Packages plugins and skills
#   - Attaches zips to the published release
#   - Deploys downloads page to skills.cirra.ai (production)
#     with links pointing to releases/latest/download/
#
# On push to main:
#   - Packages plugins and skills
#   - Deploys downloads page + zips to preview.skills-cirra-ai.pages.dev
#     (zips are served directly from CF Pages, no GitHub release needed)
#
# On push to any other branch:
#   - Packages plugins and skills
#   - Deploys downloads page + zips to <branch>.skills-cirra-ai.pages.dev

on:
  push:
    branches: ['**']
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ── Package ──────────────────────────────────────────────────────────────

      - name: Package plugins and skills
        run: ./scripts/package-all.sh

      # ── Attach zips to published release ────────────────────────────────────

      - name: Attach zips to published release
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          for zip in install/plugins/*.zip install/skills/*.zip; do
            gh release upload "${RELEASE_TAG}" "$zip" --clobber
          done

      # ── Deploy to Cloudflare Pages ───────────────────────────────────────────
      # release published → CF Pages branch 'main'     → skills.cirra.ai (production)
      #                     download links: releases/latest/download/
      # push to main      → CF Pages branch 'preview'  → preview.skills-cirra-ai.pages.dev
      #                     download links: zips bundled in the CF Pages deployment
      # push to <branch>  → CF Pages branch '<branch>' → <branch>.skills-cirra-ai.pages.dev
      #                     download links: zips bundled in the CF Pages deployment

      - name: Generate downloads page
        env:
          EVENT: ${{ github.event_name }}
        run: |
          if [[ "$EVENT" == "release" ]]; then
            bash scripts/generate-pages.sh
          else
            cp install/plugins/*.zip install/skills/*.zip docs/
            bash scripts/generate-pages.sh --dl-base=.
          fi

      - name: Deploy to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          BRANCH: ${{ github.ref_name }}
          EVENT: ${{ github.event_name }}
        run: |
          if [[ "$EVENT" == "release" ]]; then
            CF_BRANCH="main"
          elif [[ "$BRANCH" == "main" ]]; then
            CF_BRANCH="preview"
          else
            CF_BRANCH="$BRANCH"
          fi
          npx wrangler@4 pages deploy docs \
            --project-name skills-cirra-ai \
            --branch "${CF_BRANCH}"
